pipeline {
    agent any

    environment {
        GIT_REPO = 'https://github.com/tpdebenjamin/projet_devops.git'
        GIT_CREDENTIALS_ID = 'projet_devops'
    }

    parameters {
        string(name: 'BRANCH_NAME', defaultValue: 'main', description: 'Quelle branche Git déployer ?')
        choice(name: 'DEPLOY_ENV', choices: ['Development', 'Staging', 'Production'], description: 'Choisir l’environnement de déploiement')
        booleanParam(name: 'RUN_TESTS', defaultValue: true, description: 'Exécuter les tests unitaires ?')
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Clonage du repository ${params.BRANCH_NAME}..."
                checkout([
                    $class: 'GitSCM', 
                    branches: [[name: params.BRANCH_NAME]], 
                    userRemoteConfigs: [[
                        url: env.GIT_REPO,
                        credentialsId: env.GIT_CREDENTIALS_ID
                    ]]
                ])
            }
        }

        stage('Build') {
            steps {
                echo 'Étape de build en cours...'
                sh 'npm install'  // Remplace si ton projet n’est pas en Node.js
                sh 'npm run build'  // Commande de build
            }
        }

        stage('Tests') {
            when {
                expression { params.RUN_TESTS }
            }
            steps {
                echo 'Exécution des tests unitaires...'
                sh 'npm test'  // Remplace si tu utilises un autre outil de test
            }
        }

        stage('Deploy') {
            steps {
                script {
                    echo "Déploiement vers l’environnement : ${params.DEPLOY_ENV}"
                    if (params.DEPLOY_ENV == 'Development') {
                        sh 'echo "Déploiement en développement..."'
                    } else if (params.DEPLOY_ENV == 'Staging') {
                        sh 'echo "Déploiement en staging..."'
                    } else if (params.DEPLOY_ENV == 'Production') {
                        sh 'echo "Déploiement en production..."'
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline terminé.'
        }
        success {
            echo 'Pipeline réussi !'
        }
        failure {
            echo 'Le pipeline a échoué. Vérifiez les erreurs.'
        }
    }
}
